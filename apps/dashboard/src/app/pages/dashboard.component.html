<div class="dashboard-container">
  <header class="dashboard-header">
    <h1>Task Board</h1>
    <div class="header-actions">
      <span>{{ user?.email }}</span>
      <button (click)="logout()" class="logout-btn">Logout</button>
    </div>
  </header>

  <div *ngIf="canEdit" class="add-task-container">
    <input [(ngModel)]="newTaskTitle" placeholder="Enter a new task..." />

    <select [(ngModel)]="selectedUserId" class="user-select">
      <option value="" disabled selected>Assign to...</option>
      <option *ngFor="let u of users" [value]="u.id">
        {{ u.email }}
      </option>
    </select>

    <button (click)="addTask()" class="add-btn">+ Add Task</button>
  </div>

  <div *ngIf="!canEdit" class="viewer-message">
    <p>You are in <strong>View Only</strong> mode.</p>
  </div>

  <div class="board">
    
    <div class="column">
      <h2>To Do</h2>
      <div cdkDropList [cdkDropListData]="todo" [cdkDropListConnectedTo]="[doingList, doneList]" #todoList="cdkDropList"
        (cdkDropListDropped)="drop($event, 'OPEN')" class="task-list">
        
        <div *ngFor="let task of todo" cdkDrag [cdkDragDisabled]="!canEdit" class="task-card">
          
          <div class="card-header">
            <ng-container *ngIf="editingTaskId !== task.id">
              <span class="task-title">{{ task.title }}</span>
              <div class="actions" *ngIf="canEdit">
                <button class="edit-btn" (click)="startEdit(task)" (mousedown)="$event.stopPropagation()">âœŽ</button>
                <button class="delete-btn" (click)="deleteTask(task.id)" (mousedown)="$event.stopPropagation()">âœ–</button>
              </div>
            </ng-container>

            <ng-container *ngIf="editingTaskId === task.id">
              <input [(ngModel)]="editedTitle" class="edit-input" (keydown.enter)="saveEdit(task)" (mousedown)="$event.stopPropagation()" />
              <div class="actions">
                <button class="save-btn" (click)="saveEdit(task)" (mousedown)="$event.stopPropagation()">âœ“</button>
                <button class="cancel-btn" (click)="cancelEdit()" (mousedown)="$event.stopPropagation()">Esc</button>
              </div>
            </ng-container>
          </div>

          <div class="assignee-chip" *ngIf="task.assignedTo">
            <small>ðŸ‘¤ {{ task.assignedTo.email }}</small>
          </div>
        </div>
      </div>
    </div>

    <div class="column">
      <h2>In Progress</h2>
      <div cdkDropList [cdkDropListData]="inProgress" [cdkDropListConnectedTo]="[todoList, doneList]" #doingList="cdkDropList"
        (cdkDropListDropped)="drop($event, 'IN_PROGRESS')" class="task-list">
        
        <div *ngFor="let task of inProgress" cdkDrag [cdkDragDisabled]="!canEdit" class="task-card">
          
          <div class="card-header">
            <ng-container *ngIf="editingTaskId !== task.id">
              <span class="task-title">{{ task.title }}</span>
              <div class="actions" *ngIf="canEdit">
                <button class="edit-btn" (click)="startEdit(task)" (mousedown)="$event.stopPropagation()">âœŽ</button>
                <button class="delete-btn" (click)="deleteTask(task.id)" (mousedown)="$event.stopPropagation()">âœ–</button>
              </div>
            </ng-container>

            <ng-container *ngIf="editingTaskId === task.id">
              <input [(ngModel)]="editedTitle" class="edit-input" (keydown.enter)="saveEdit(task)" (mousedown)="$event.stopPropagation()" />
              <div class="actions">
                <button class="save-btn" (click)="saveEdit(task)" (mousedown)="$event.stopPropagation()">âœ“</button>
                <button class="cancel-btn" (click)="cancelEdit()" (mousedown)="$event.stopPropagation()">Esc</button>
              </div>
            </ng-container>
          </div>

          <div class="assignee-chip" *ngIf="task.assignedTo">
            <small>ðŸ‘¤ {{ task.assignedTo.email }}</small>
          </div>
        </div>
      </div>
    </div>

    <div class="column">
      <h2>Done</h2>
      <div cdkDropList [cdkDropListData]="done" [cdkDropListConnectedTo]="[todoList, doingList]" #doneList="cdkDropList"
        (cdkDropListDropped)="drop($event, 'DONE')" class="task-list">
        
        <div *ngFor="let task of done" cdkDrag [cdkDragDisabled]="!canEdit" class="task-card done-card">
          
          <div class="card-header">
            <ng-container *ngIf="editingTaskId !== task.id">
              <span class="task-title">{{ task.title }}</span>
              <div class="actions" *ngIf="canEdit">
                <button class="edit-btn" (click)="startEdit(task)" (mousedown)="$event.stopPropagation()">âœŽ</button>
                <button class="delete-btn" (click)="deleteTask(task.id)" (mousedown)="$event.stopPropagation()">âœ–</button>
              </div>
            </ng-container>

            <ng-container *ngIf="editingTaskId === task.id">
              <input [(ngModel)]="editedTitle" class="edit-input" (keydown.enter)="saveEdit(task)" (mousedown)="$event.stopPropagation()" />
              <div class="actions">
                <button class="save-btn" (click)="saveEdit(task)" (mousedown)="$event.stopPropagation()">âœ“</button>
                <button class="cancel-btn" (click)="cancelEdit()" (mousedown)="$event.stopPropagation()">Esc</button>
              </div>
            </ng-container>
          </div>

          <div class="assignee-chip" *ngIf="task.assignedTo">
            <small>ðŸ‘¤ {{ task.assignedTo.email }}</small>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>